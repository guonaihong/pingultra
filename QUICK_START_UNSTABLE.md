# 短暂连不上 IP 监控 - 快速开始指南

## 快速概览

PingUltra 现在可以精确监控网络中 IP 短暂连不上的情况。通过新增的 **Unstable（不稳定）** 状态，你可以一眼识别出哪些设备网络连接不稳定。

## 核心概念

### 设备状态

| 状态 | 含义 | 颜色 |
|------|------|------|
| 🟢 Online | 正常在线 | 绿色 |
| 🟡 Unstable | **短暂连不上**（连续失败 2 次） | 黄色 |
| 🔴 Offline | 完全离线（连续失败 5 次） | 红色 |
| ⚠️ Lost | 长期未响应 | 红色加粗 |

### 关键指标

- **连续失败次数**：设备连续 ping 失败的次数
- **离线事件**：记录每次离线的开始时间、恢复时间和持续时长
- **最后失败时间**：最后一次 ping 失败的时间

## 使用方法

### 1. 启动监控

```bash
# 基础命令
sudo pingultra monitor -n 192.168.1.0/24 -u -i 1

# 参数说明
# -n: 网络范围（CIDR 格式）
# -u: 启用交互式 UI
# -i: 扫描间隔（秒）
```

### 2. 查看界面

启动后你会看到：

```
┌─ PingUltra Network Monitor ──────────────────────────────────────────┐
│ IP               存活时间         MAC           Hostname    Vendor    Status
├──────────────────────────────────────────────────────────────────────┤
│ 192.168.1.1      00:05:23         aa:bb:cc:dd   router      TP-Link   Online
│ 192.168.1.100    00:02:15         11:22:33:44   pc-001      Apple     Online
│ 192.168.1.101    00:00:45         55:66:77:88   printer     Canon     Unstable ⚠️
│ 192.168.1.102    00:00:12         99:aa:bb:cc   camera      Hikvision Offline
│
│ 设备总数: 25 | 在线: 23 | 不稳定: 1 | 离线: 1 | 新设备: 0 | 丢失: 0
│ 按键: [q]退出 [s]切换排序 [↑/↓]导航
└──────────────────────────────────────────────────────────────────────┘
```

### 3. 快捷键

| 快捷键 | 功能 |
|--------|------|
| `q` / `ESC` | 退出（详情页返回列表） |
| `e` | 查看设备详情 |
| `s` | 切换排序 |
| `↑` / `↓` 或 `j` / `k` | 导航或滚动（Vim 风格） |

## 详情页面使用

按 `e` 键进入选中设备的详情页面，可以查看：

1. **设备基本信息**
   - MAC 地址
   - 厂商信息
   - 主机名

2. **设备状态**
   - 当前状态（Online/Unstable/Offline 等）
   - 连续失败次数

3. **离线事件历史**
   - 每次离线的时间段
   - 离线持续时长
   - 是否已恢复

4. **统计信息**
   - 总离线次数
   - 平均离线时长

**在详情页面中**：
- 按 `↑/↓` 或 `j/k` 滚动查看更多离线事件
- 按 `q` 或 `ESC` 返回设备列表

## 常见场景

### 场景 1：识别 WiFi 连接不稳定的设备

1. 启动监控：`sudo pingultra monitor -n 192.168.1.0/24 -u -i 1`
2. 查看 **Unstable** 状态的设备
3. 这些设备表示网络连接不稳定

**可能的原因**：
- WiFi 信号弱
- 设备距离路由器太远
- 干扰源（微波炉、无绳电话等）
- 设备驱动问题

### 场景 2：诊断间歇性网络故障

1. 启动监控并观察一段时间
2. 注意 **Unstable** 设备数量的变化
3. 如果大量设备变为 Unstable → 网络干扰
4. 如果特定设备频繁 Unstable → 该设备问题

### 场景 3：监控关键设备

```bash
# 监控特定网段的关键设备
sudo pingultra monitor -n 192.168.1.0/24 -u -i 1 -m

# -m 选项会解析 MAC 地址的厂商信息
# 帮助你快速识别设备类型
```

## 数据含义

### 底部统计栏

```
设备总数: 25 | 在线: 23 | 不稳定: 1 | 离线: 1 | 新设备: 0 | 丢失: 0
```

- **设备总数**：扫描范围内的总设备数
- **在线**：正常响应 ping 的设备
- **不稳定**：连续失败 2 次的设备 ← **关键指标**
- **离线**：连续失败 5 次的设备
- **新设备**：首次发现的设备
- **丢失**：长期未响应的设备

### 设备列表

| 列 | 含义 |
|----|------|
| IP | 设备 IP 地址 |
| 存活时间 | 从首次发现到现在的时间 |
| MAC | 设备 MAC 地址 |
| Hostname | 设备主机名 |
| Vendor | MAC 地址对应的厂商 |
| Status | 当前状态 |

## 故障排查

### 问题 1：没有扫描到任何设备

**原因**：需要 root 权限

**解决**：
```bash
sudo ./target/release/pingultra monitor -n 192.168.1.0/24 -u -i 1
```

### 问题 2：设备状态频繁变化

**原因**：网络不稳定或扫描间隔太短

**解决**：
- 增加扫描间隔：`-i 5`（5 秒）
- 检查网络连接质量

### 问题 3：看不到 MAC 地址

**原因**：未启用 MAC 地址解析

**解决**：
```bash
sudo pingultra monitor -n 192.168.1.0/24 -u -i 1 -m
```

## 高级用法

### 监控并导出数据

```bash
# 启用 UI 监控
sudo pingultra monitor -n 192.168.1.0/24 -u -i 1

# 同时在另一个终端导出数据（需要实现导出功能）
```

### 只显示不稳定设备

```bash
# 使用 grep 过滤输出
sudo pingultra monitor -n 192.168.1.0/24 | grep -i unstable
```

### 长期监控

```bash
# 后台运行监控
nohup sudo pingultra monitor -n 192.168.1.0/24 -u -i 1 > monitor.log 2>&1 &
```

## 性能建议

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 网络范围 | /24 | 最多 254 个 IP |
| 扫描间隔 | 1-5 秒 | 太短会占用资源 |
| Ping 超时 | 500ms | 默认值 |
| 重试次数 | 1 | 默认值 |

## 更多信息

- 详细设计方案：[DESIGN_UNSTABLE_MONITORING.md](./DESIGN_UNSTABLE_MONITORING.md)
- 完整文档：[README.md](./README.md)

## 常见问题

**Q: Unstable 和 Offline 有什么区别？**
A: 
- Unstable：连续失败 2 次，表示短暂连不上，可能很快恢复
- Offline：连续失败 5 次，表示完全离线，需要更长时间恢复

**Q: 离线事件会保存多久？**
A: 在程序运行期间会保存所有离线事件。程序重启后会清空。

**Q: 能否监控多个网段？**
A: 目前一次只能监控一个网段，但可以启动多个进程分别监控不同网段。

**Q: 如何快速找到不稳定的设备？**
A: 
1. 查看底部统计栏的 "不稳定" 数量
2. 设备列表中 Unstable 状态的设备会显示在在线设备之后
3. 使用 `↑/↓` 快速导航

---

**提示**：定期运行监控可以帮助你及时发现网络问题，提高网络稳定性！
